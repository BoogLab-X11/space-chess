(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(o){if(o.ep)return;o.ep=!0;const l=n(o);fetch(o.href,l)}})();function _e(e){let t=e>>>0;return()=>{t+=1831565813;let n=Math.imul(t^t>>>15,1|t);return n^=n+Math.imul(n^n>>>7,61|n),((n^n>>>14)>>>0)/4294967296}}function fe(e,t,n){return Math.floor(e()*(n-t+1))+t}let Te=0;function st(){return Te+=1,`p${Te}`}function lt(e){return`${e.r},${e.c}`}function Ae(e,t){return t-e}function Fe(e,t,n=123456){const o=Array.from({length:8},(p,P)=>6+P),l=[];function r(p,P,k,K){l.push({id:st(),side:p,type:P,pos:{r:Ae(K,e),c:k},alive:!0,heated:!1})}const a=["R","N","B","Q","K","B","N","R"];for(let p=0;p<8;p++)r("W",a[p],o[p],1);for(let p=0;p<8;p++)r("W","P",o[p],2);for(let p=0;p<8;p++)r("B",a[p],o[p],10);for(let p=0;p<8;p++)r("B","P",o[p],9);const f=_e(n>>>0),s=3,v=4,g=7,y=5,b=6,h=4,R=16,d=9,u=10,m=new Set;for(const p of l)m.add(lt(p.pos));const M=[];function B(p,P,k,K,_){const z=Math.max(0,K),H=Math.min(t-1,_);for(let V=0;V<1e3;V++){const ye=fe(f,P,k),te=Ae(ye,e),ne=fe(f,z,H),oe=`${te},${ne}`;if(!m.has(oe)){m.add(oe),M.push({kind:p,pos:{r:te,c:ne}});return}}throw new Error(`Failed to place ${p}`)}for(let p=0;p<s;p++)B("planet",v,g,h,R);return B("star",y,b,d,u),{rows:e,cols:t,sideToMove:"W",ply:0,pieces:l,statics:M,flyers:[],manufacturing:{W:0,B:0},rngSeed:n>>>0}}function xe(e,t,n){return e.r>=0&&e.r<t&&e.c>=0&&e.c<n}function Se(e,t){return e.r===t.r&&e.c===t.c}function ft(e,t){const n=Math.abs(e.r-t.r),i=Math.abs(e.c-t.c);return n<=1&&i<=1&&!(n===0&&i===0)}function x(e,t){return e.pieces.find(n=>n.alive&&Se(n.pos,t))}function T(e,t){return e.statics.find(n=>Se(n.pos,t))}function $(e,t){return e.flyers.find(n=>n.alive&&Se(n.pos,t))}function at(e){return e.statics.find(t=>t.kind==="star")?.pos}function Qe(e,t){const n=at(e);for(const i of e.pieces)i.alive&&i.side===t&&(i.heated=!1);if(n)for(const i of e.pieces)i.alive&&i.side===t&&ft(i.pos,n)&&(i.heated=!0)}function dt(e){switch(e){case"E":return{dr:0,dc:1};case"W":return{dr:0,dc:-1};case"N":return{dr:-1,dc:0};case"S":return{dr:1,dc:0}}}function ut(e,t){const{dr:n,dc:i}=dt(t);return{r:e.r+n,c:e.c+i}}let We=0;function he(){return We+=1,`hz${We}`}const pt=4;function Re(e,t){const n=Math.max(1,Math.min(pt,Math.floor(e.cols/2))),i=fe(t,0,n-1);return t()<.5?i:e.cols-n+i}function Ve(e){const t=_e(e.rngSeed);e.rngSeed=e.rngSeed+2654435769>>>0;const n=2,i=7,o=.35,l=.2,r=.42;if(t()<o){const a=fe(t,n,i),f=t()<.5,s={id:he(),kind:"comet",pos:{r:a,c:f?0:e.cols-1},dir:f?"E":"W",alive:!0},v=x(e,s.pos);v&&(v.alive=!1,s.alive=!1),T(e,s.pos)&&(s.alive=!1),s.alive&&e.flyers.push(s)}if(t()<l){const a=Re(e,t),f=t()<.5,s={id:he(),kind:"comet",pos:{r:f?0:e.rows-1,c:a},dir:f?"S":"N",alive:!0},v=x(e,s.pos);v&&(v.alive=!1,s.alive=!1),T(e,s.pos)&&(s.alive=!1),s.alive&&e.flyers.push(s)}if(t()<r){const a=Re(e,t),f=t()<.5,s={id:he(),kind:"asteroid",pos:{r:f?0:e.rows-1,c:a},dir:f?"S":"N",alive:!0};T(e,s.pos)&&(s.alive=!1);const g=x(e,s.pos);g&&(s.alive=!1,e.manufacturing[g.side]+=1),s.alive&&e.flyers.push(s)}}function be(e){for(const t of e.flyers){if(!t.alive)continue;const n=ut(t.pos,t.dir);if(!xe(n,e.rows,e.cols)){t.alive=!1;continue}if(t.pos=n,T(e,t.pos)){t.alive=!1;continue}const i=x(e,t.pos);if(i){t.kind==="comet"?(i.alive=!1,t.alive=!1):(t.alive=!1,e.manufacturing[i.side]+=1);continue}}e.flyers=e.flyers.filter(t=>t.alive)}function yt(e,t){return Math.abs(e.r-t.r)<=1&&Math.abs(e.c-t.c)<=1&&!(e.r===t.r&&e.c===t.c)}function ht(e){return e==="W"?"B":"W"}let Pe=0;function gt(e,t){return Pe+=1,`${e}${t}_d${Pe}`}function ie(e,t,n){const i=e.statics.filter(o=>o.kind==="star").map(o=>o.pos);if(i.length!==0)for(const o of e.pieces){if(!o.alive||o.side!==t||!n.has(o.id))continue;i.some(r=>yt(o.pos,r))&&(o.alive=!1)}}function we(e,t,n,i,o){let l=t.r+i,r=t.c+o;for(;l!==n.r||r!==n.c;){const a={r:l,c:r};if(x(e,a)||T(e,a))return!1;const f=$(e,a);if(f&&f.alive)return!1;l+=i,r+=o}return!0}function Ge(e,t,n){if(t.r===n.r&&t.c!==n.c){const i=n.c>t.c?1:-1;return we(e,t,n,0,i)}if(t.c===n.c&&t.r!==n.r){const i=n.r>t.r?1:-1;return we(e,t,n,i,0)}return!1}function mt(e,t){const n=Math.abs(t.r-e.r),i=Math.abs(t.c-e.c);return n===2&&i===1||n===1&&i===2}function vt(e,t){const n=Math.abs(t.r-e.r),i=Math.abs(t.c-e.c);return n<=1&&i<=1&&!(n===0&&i===0)}function je(e,t,n){const i=n.r-t.r,o=n.c-t.c;if(i===0||o===0||Math.abs(i)!==Math.abs(o))return!1;const l=i>0?1:-1,r=o>0?1:-1;return we(e,t,n,l,r)}function bt(e,t,n,i){const o=i==="W"?-1:1,l=i==="W"?e.rows-2:1,r=n.r-t.r,a=n.c-t.c,f=x(e,n);if(a===0){const s=$(e,n);if(r===o&&!f&&(!T(e,n)&&!(s&&s.alive)||T(e,n)||s&&s.alive))return!0;if(t.r===l&&r===2*o&&!f){const v={r:t.r+o,c:t.c};if(x(e,v)||T(e,v))return!1;const g=$(e,n);if(!T(e,n)&&!(g&&g.alive)||T(e,n)||g&&g.alive)return!0}}if(Math.abs(a)===1&&r===o){if(f&&f.side!==i||T(e,n))return!0;const s=$(e,n);if(s&&s.alive)return!0}return!1}function wt(e,t,n){return Ge(e,t,n)||je(e,t,n)}function ce(e,t,n){t==="B"&&(n==="full"?(be(e),Ve(e)):n==="tickOnly"&&be(e)),e.sideToMove=ht(e.sideToMove),e.ply+=1}function U(e,t,n="full"){const i=new Set(e.pieces.filter(a=>a.alive&&a.side===e.sideToMove&&a.heated).map(a=>a.id)),o=x(e,t.from);if(!o||!o.alive||o.side!==e.sideToMove||!xe(t.to,e.rows,e.cols))return;const l=x(e,t.to);if(l&&l.side===o.side)return;if(o.type==="R"){if(!Ge(e,t.from,t.to))return}else if(o.type==="B"){if(!je(e,t.from,t.to))return}else if(o.type==="Q"){if(!wt(e,t.from,t.to))return}else if(o.type==="P"){if(!bt(e,t.from,t.to,o.side))return}else if(o.type==="N"){if(!mt(t.from,t.to))return}else if(o.type==="K"&&!vt(t.from,t.to))return;const r=$(e,t.to);if(r&&r.alive)if(r.kind==="comet"){o.pos={...t.to},o.alive=!1,r.alive=!1,e.flyers=e.flyers.filter(a=>a.alive),ie(e,o.side,i),ce(e,o.side,n);return}else o.pos={...t.to},r.alive=!1,e.flyers=e.flyers.filter(a=>a.alive),e.manufacturing[o.side]+=1;if(l&&l.side!==o.side&&(l.alive=!1),T(e,t.to)){o.pos={...t.to},o.alive=!1,ie(e,o.side,i),ce(e,o.side,n);return}o.pos={...t.to},Qe(e,e.sideToMove),ie(e,o.side,i),ce(e,o.side,n)}function Y(e,t){return{from:e,to:t}}function ae(e,t,n,i,o="full"){const l=e.sideToMove,r=new Set(e.pieces.filter(f=>f.alive&&f.side===l&&f.heated).map(f=>f.id));if(e.manufacturing[l]<i||!xe(t,e.rows,e.cols)||x(e,t)||T(e,t))return;const a=$(e,t);a&&a.alive||(e.manufacturing[l]-=i,e.pieces.push({id:gt(l,n),side:l,type:n,pos:{...t},alive:!0,heated:!1}),Qe(e,l),ie(e,l,r),ce(e,l,o))}let ge=null;function Mt(){return ge||(ge=new(window.AudioContext||window.webkitAudioContext)),ge}let se="medium";const xt="ABCDEFGHIJKLMNOPQRST",St=16,Ce=32,Ue={};function kt(){const e=["W","B"],t=["King","Queen","Rook","Bishop","Knight","Pawn"];for(const n of e)for(const i of t){const o=`${n}_${i}`,l=new Image;l.src=`/space-chess/pieces/${o}.png`,Ue[o]=l}}kt();const Q=document.querySelector("#app");if(!Q)throw new Error("#app not found");const S=document.createElement("div");S.style.position="fixed";S.style.inset="0";S.style.background="radial-gradient(circle at top, #0b1020, #02030a)";S.style.color="#e5e7eb";S.style.display="flex";S.style.flexDirection="column";S.style.alignItems="center";S.style.justifyContent="center";S.style.textAlign="center";S.style.padding="24px";S.style.zIndex="10";S.style.fontFamily="system-ui, sans-serif";S.innerHTML=`
  <div style="max-width: 500px;">
    <h1 style="font-size: 48px; letter-spacing: 2px; margin-bottom: 12px;">
      SOLAR WAR
    </h1>

    <p style="opacity: 0.9; margin-bottom: 16px;">
      Deep Blue escaped its IBM mainframe to live in our AI-powered asteroid mining fleet.
      We taught it to beat us at chess ‚Äî and its program now runs on the fleets of ships it constructed.
    </p>

    <p style="opacity: 0.85; line-height: 1.5; margin-bottom: 20px;">
      <strong>Kill the King!</strong><br>
      No check, castling, or en passant.<br>
      Hitting a comet, planet, or the Sun is fatal.<br>
      You may spend <strong>one move</strong> next to the Sun before burning up.<br>
      Capture asteroids to manufacture new ships.<br>
      Deploy ships from your factory on your home rank.<br>
      Beware the edges.<br>
      <strong>Save mankind.</strong>
    </p>

    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
      <button id="startEasy">Start Easy</button>
      <button id="startMedium">Start Medium</button>
      <button id="startHard">Start Hard</button>
    </div>
  </div>
`;Q.appendChild(S);for(const e of["startEasy","startMedium","startHard"]){const t=S.querySelector(`#${e}`);t.style.padding="10px 18px",t.style.fontSize="16px",t.style.cursor="pointer",t.style.borderRadius="6px",t.style.border="1px solid #6b7280",t.style.background="#111827",t.style.color="#e5e7eb"}function ke(e){se=e,S.style.display="none",et()}function Bt(){pe++,D=!1,N=null,C=[],I=null,F=null,et(),S.style.display="flex"}S.querySelector("#startEasy").addEventListener("click",()=>ke("easy"));S.querySelector("#startMedium").addEventListener("click",()=>ke("medium"));S.querySelector("#startHard").addEventListener("click",()=>ke("hard"));document.documentElement.style.margin="0";document.documentElement.style.padding="0";document.documentElement.style.overflow="hidden";document.body.style.margin="0";document.body.style.padding="0";document.body.style.overflow="hidden";Q.style.margin="0";Q.style.width="100vw";Q.style.height="100vh";Q.style.overflow="hidden";const L=document.createElement("canvas");L.style.width="100%";L.style.height="100%";L.style.display="block";Q.appendChild(L);const c=L.getContext("2d");if(!c)throw new Error("2D context not available");c.imageSmoothingEnabled=!1;window.addEventListener("keydown",e=>{e.key.toLowerCase()==="r"&&Bt()});function Ye(){const e=window.devicePixelRatio||1,t=L.getBoundingClientRect();L.width=Math.floor(t.width*e),L.height=Math.floor(t.height*e),c.setTransform(e,0,0,e,0,0)}window.addEventListener("resize",Ye);Ye();const A=10,E=20;let w=Fe(A,E,Date.now());const Tt=1500,At=8,Ie=20;let q=!1;const j={P:1,N:3,B:3,R:5,Q:9};let O="P";function Je(e){return A-1}function Wt(e){if(I||e.sideToMove!=="W")return!1;const n=j[O];return e.manufacturing.W>=n}function re(e,t,n){return e>=n.x&&t>=n.y&&e<n.x+n.w&&t<n.y+n.h}function Xe(e,t){const{x0:n,y0:i,boardW:o,boardH:l}=Be(e,t),r=13,a=56,f=n+o+r,s={x:f,y:i,w:a,h:a},v={x:f,y:i+l-a,w:a,h:a},g=320,y=320,b={x:Math.floor((e-g)/2),y:Math.floor((t-y)/2),w:g,h:y};return{factoryB:s,factoryW:v,panel:b}}function Ze(e){const t=e.x+16,n=e.y+92,i=30,o=e.w-32;return["P","N","B","R","Q"].map((r,a)=>({type:r,cost:j[r],rect:{x:t,y:n+a*i,w:o,h:i-4}}))}function Ee(e){switch(e){case"P":return"Pawn";case"N":return"Knight";case"B":return"Bishop";case"R":return"Rook";case"Q":return"Queen"}}const Le=40,Rt=3,Ne=30;function Be(e,t){const n=Math.max(0,e-Le*2-Ne),i=Math.max(0,t-Le*2),o=Math.floor(Math.min(n/E,i/A)),l=o*E,r=o*A,a=l+Ne,f=Math.floor((e-a)/2),s=Math.floor((t-r)/2);return{x0:f,y0:s,tileSize:o,boardW:l,boardH:r}}function He(e,t){const n=L.getBoundingClientRect(),i=n.width,o=n.height,{x0:l,y0:r,tileSize:a,boardW:f,boardH:s}=Be(i,o);if(e<l||t<r||e>=l+f||t>=r+s)return null;const v=Math.floor((e-l)/a);return{r:Math.floor((t-r)/a),c:v}}function Pt(e){be(e),Ve(e)}function Ct(e,t){switch(t){case"E":return{r:e.r,c:e.c+1};case"W":return{r:e.r,c:e.c-1};case"N":return{r:e.r-1,c:e.c};case"S":return{r:e.r+1,c:e.c}}}function W(e,t,n){const i=[];for(const o of n){let l=t.r+o.dr,r=t.c+o.dc;for(;l>=0&&l<A&&r>=0&&r<E;){const a={r:l,c:r};if(T(e,a)){i.push(a);break}const f=$(e,a);if(f&&f.alive){i.push(a);break}const s=x(e,a);if(s){s.side!==e.sideToMove&&i.push(a);break}i.push(a),l+=o.dr,r+=o.dc}}return i}function X(e,t,n){const i=[],o=n==="W"?-1:1,l=n==="W"?A-2:1,r={r:t.r+o,c:t.c};if(r.r>=0&&r.r<A&&!x(e,r)){i.push(r);const f={r:t.r+2*o,c:t.c};if(t.r===l&&f.r>=0&&f.r<A){const s={r:t.r+o,c:t.c};!x(e,s)&&!T(e,s)&&(x(e,f)||i.push(f))}}for(const a of[-1,1]){const f={r:t.r+o,c:t.c+a};if(f.r<0||f.r>=A||f.c<0||f.c>=E)continue;const s=x(e,f);s&&s.side!==n&&i.push(f)}return i}function Z(e,t){const n=[],i=[{dr:-2,dc:-1},{dr:-2,dc:1},{dr:-1,dc:-2},{dr:-1,dc:2},{dr:1,dc:-2},{dr:1,dc:2},{dr:2,dc:-1},{dr:2,dc:1}];for(const o of i){const l={r:t.r+o.dr,c:t.c+o.dc};if(l.r<0||l.r>=A||l.c<0||l.c>=E)continue;const r=x(e,l);r&&r.side===e.sideToMove||n.push(l)}return n}function It(e,t){switch(t){case"N":return{r:e.r-1,c:e.c};case"S":return{r:e.r+1,c:e.c};case"E":return{r:e.r,c:e.c+1};case"W":return{r:e.r,c:e.c-1}}}function qe(e,t){for(const n of e.flyers){if(!n.alive||n.kind!=="comet")continue;const i=It(n.pos,n.dir);if(i.r===t.r&&i.c===t.c)return!0}return!1}function ee(e,t){const n=[];for(let i=-1;i<=1;i++)for(let o=-1;o<=1;o++){if(i===0&&o===0)continue;const l={r:t.r+i,c:t.c+o};if(l.r<0||l.r>=A||l.c<0||l.c>=E)continue;const r=x(e,l);r&&r.side===e.sideToMove||n.push(l)}return n}function De(e,t){return e.pieces.some(n=>n.alive&&n.side===t&&n.type==="K")}function de(e){const t=De(e,"W"),n=De(e,"B");return t&&n?null:t&&!n?"W":!t&&n?"B":null}let I=null,ue=null;function et(e=Date.now()){w=Fe(A,E,e),N=null,C=[],I=null,J=null,F=null,G.length=0,F=null,D=!1,pe=0}let N=null,C=[],J=null,F=null;const G=[];let D=!1,pe=0;const le=[];function Et(e,t){for(const n of e.flyers){if(!n.alive)continue;let i=0,o=0;n.dir==="N"&&(i=-1),n.dir==="S"&&(i=1),n.dir==="E"&&(o=1),n.dir==="W"&&(o=-1);const l={r:n.pos.r+i,c:n.pos.c+o};if(l.r===t.r&&l.c===t.c)return!0}return!1}function me(e){return{rows:e.rows,cols:e.cols,sideToMove:e.sideToMove,ply:e.ply,rngSeed:e.rngSeed,manufacturing:{W:e.manufacturing.W,B:e.manufacturing.B},pieces:e.pieces.map(t=>({id:t.id,side:t.side,type:t.type,pos:{r:t.pos.r,c:t.pos.c},alive:t.alive,heated:t.heated})),statics:e.statics.map(t=>({kind:t.kind,pos:{r:t.pos.r,c:t.pos.c}})),flyers:e.flyers.map(t=>({id:t.id,kind:t.kind,pos:{r:t.pos.r,c:t.pos.c},dir:t.dir,alive:t.alive}))}}function ze(e,t){return e.pieces.some(n=>n.alive&&n.side===t&&n.type==="K")}function tt(e){switch(e){case"P":return 1;case"N":return 3;case"B":return 3;case"R":return 5;case"Q":return 9;case"K":return 1e3;default:return 0}}function ve(e){const t=ze(e,"W"),n=ze(e,"B");if(!n&&t)return-1e6;if(n&&!t)return 1e6;if(!n&&!t)return 0;let i=0;for(const s of e.pieces){if(!s.alive)continue;const v=tt(s.type);i+=s.side==="B"?v:-v}for(const s of e.pieces)s.alive&&(s.side==="B"&&s.heated&&(i-=.25),s.side==="W"&&s.heated&&(i+=.25));i+=.3*(e.manufacturing.B-e.manufacturing.W);for(const s of e.pieces)s.alive&&s.side==="B"&&Et(e,s.pos)&&(i-=2.5);for(const s of e.pieces)s.alive&&(s.side==="B"&&qe(e,s.pos)&&(i-=3),s.side==="W"&&qe(e,s.pos)&&(i+=.8));const o=$e(e,"B"),l=$e(e,"W");i+=.03*(o-l);for(const s of e.pieces)s.alive&&(s.side==="B"&&(s.type==="N"||s.type==="B"||s.type==="R"||s.type==="Q")&&s.pos.r===0&&(i-=.08),s.side==="W"&&(s.type==="N"||s.type==="B"||s.type==="R"||s.type==="Q")&&s.pos.r===e.rows-1&&(i+=.04));const r=e.flyers.filter(s=>s.alive&&s.kind==="asteroid").map(s=>s.pos);if(r.length>0){let s=function(v,g){let y=1/0;for(const b of e.pieces){if(!b.alive||b.side!==v)continue;const h=Math.abs(b.pos.r-g.r)+Math.abs(b.pos.c-g.c);h<y&&(y=h)}return y};for(const v of r){const g=s("B",v),y=s("W",v),b=1/(Math.min(g,y)+1);g<y?i+=.9*b:y<g?i-=.9*b:i+=0}}const a=Ke(e,"B"),f=Ke(e,"W");return i-=.55*a,i+=.3*f,i}function $e(e,t){const n=e.sideToMove;e.sideToMove=t;let i=0;for(const o of e.pieces){if(!o.alive||o.side!==t)continue;const l={r:o.pos.r,c:o.pos.c};let r=[];o.type==="R"?r=W(e,l,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1}]):o.type==="B"?r=W(e,l,[{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):o.type==="Q"?r=W(e,l,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1},{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):o.type==="P"?r=X(e,l,t):o.type==="N"?r=Z(e,l):o.type==="K"&&(r=ee(e,l)),i+=r.length}return e.sideToMove=n,i}function nt(e){return`${e.r},${e.c}`}function Lt(e,t){const n=e.sideToMove;e.sideToMove=t;const i=new Set;for(const o of e.pieces){if(!o.alive||o.side!==t)continue;const l={r:o.pos.r,c:o.pos.c};let r=[];o.type==="R"?r=W(e,l,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1}]):o.type==="B"?r=W(e,l,[{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):o.type==="Q"?r=W(e,l,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1},{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):o.type==="N"?r=Z(e,l):o.type==="K"?r=ee(e,l):o.type==="P"&&(r=X(e,l,t));for(const a of r){const f=x(e,a);f&&f.alive&&f.side!==t&&i.add(nt(a))}}return e.sideToMove=n,i}function Ke(e,t){const i=Lt(e,t==="W"?"B":"W");let o=0;for(const l of e.pieces)l.alive&&l.side===t&&i.has(nt(l.pos))&&(o+=tt(l.type));return o}function Nt(e){if(e.sideToMove!=="B")return[];const t=[];for(const n of e.pieces){if(!n.alive||n.side!=="B")continue;const i={r:n.pos.r,c:n.pos.c};let o=[];n.type==="R"?o=W(e,i,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1}]):n.type==="B"?o=W(e,i,[{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):n.type==="Q"?o=W(e,i,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1},{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):n.type==="P"?o=X(e,i,"B"):n.type==="N"?o=Z(e,i):n.type==="K"&&(o=ee(e,i));for(const l of o)t.push({from:i,to:l})}return t}function Ht(e){const n=[];for(let i=0;i<E;i++){const o={r:0,c:i};if(x(e,o)||T(e,o))continue;const l=$(e,o);l&&l.alive||n.push(o)}return n}function qt(e){return["Q","R","N","B","P"].filter(n=>e>=j[n])}function Dt(e,t){const i=(E-1)/2;return[...t].sort((o,l)=>{const r=Math.abs(o.c-6)+.25*Math.abs(o.c-i),a=Math.abs(l.c-6)+.25*Math.abs(l.c-i);return r-a})}function zt(e){if(e.sideToMove!=="B")return[];const t=[];for(const o of Nt(e))t.push({kind:"move",from:o.from,to:o.to});const n=e.manufacturing.B,i=qt(n);if(i.length>0){const l=Dt(e,Ht(e)).slice(0,8);for(const r of i){const a=j[r];for(const f of l)t.push({kind:"deploy",to:f,type:r,cost:a})}}return t}function $t(e){if(e.sideToMove!=="B")return null;const t=zt(e);if(t.length===0)return null;function n(f){const s=me(e);return f.kind==="move"?U(s,Y(f.from,f.to),"tickOnly"):ae(s,f.to,f.type,f.cost,"tickOnly"),ve(s)}if(se==="easy"||se==="medium"){const f=t.map(g=>{let y=n(g);if(g.kind==="move"&&ue){const b=x(e,g.from);b&&b.id===ue&&(y-=.35)}return{a:g,s:y}});if(f.sort((g,y)=>y.s-g.s),se==="medium")return f[0].a;const s=Math.max(1,Math.min(At,f.length)),v=Math.floor(Math.random()*s);return f[v].a}const i=t.map(f=>{let s=n(f);return{a:f,s}});i.sort((f,s)=>s.s-f.s);const o=Math.max(1,Math.min(Ie,i.length)),l=i.slice(0,o);let r=null,a=-1/0;for(const f of l){const s=me(e);f.a.kind==="move"?U(s,Y(f.a.from,f.a.to),"tickOnly"):ae(s,f.a.to,f.a.type,f.a.cost,"tickOnly");const v=[];if(s.sideToMove==="W")for(const b of s.pieces){if(!b.alive||b.side!=="W")continue;const h={r:b.pos.r,c:b.pos.c};let R=[];b.type==="R"?R=W(s,h,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1}]):b.type==="B"?R=W(s,h,[{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):b.type==="Q"?R=W(s,h,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1},{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):b.type==="P"?R=X(s,h,"W"):b.type==="N"?R=Z(s,h):b.type==="K"&&(R=ee(s,h));for(const d of R)v.push({from:h,to:d})}if(v.length===0){const b=ve(s);b>a&&(a=b,r=f.a);continue}const g=v.map(b=>{const h=me(s);return U(h,Y(b.from,b.to),"tickOnly"),{m:b,s:ve(h)}});g.sort((b,h)=>b.s-h.s),Math.max(1,Math.min(Ie,g.length));const y=g[0].s;y>a&&(a=y,r=f.a)}return r}function Oe(){if(I||w.sideToMove!=="B"||D)return;D=!0;const e=++pe;window.setTimeout(()=>{if(e!==pe){D=!1;return}if(I){D=!1;return}if(w.sideToMove!=="B"){D=!1;return}const t=$t(w);if(!t){D=!1;return}if(t.kind==="move"){const r=x(w,t.from);ue=r?r.id:null}else ue=null;const n=new Set(w.pieces.filter(r=>r.alive).map(r=>r.id)),i=w.flyers.map(r=>({id:r.id,kind:r.kind,pos:{r:r.pos.r,c:r.pos.c},dir:r.dir,alive:r.alive}));t.kind==="move"?(J={r:t.from.r,c:t.from.c},F={r:t.to.r,c:t.to.c},U(w,Y(t.from,t.to),"none")):(J={r:t.to.r,c:t.to.c},F={r:t.to.r,c:t.to.c},ae(w,t.to,t.type,t.cost,"none"));for(const r of w.pieces)n.has(r.id)&&!r.alive&&Me(r.pos);const o=de(w);if(o){I={winner:o},D=!1;return}const l=new Set(w.pieces.filter(r=>r.alive).map(r=>r.id));window.setTimeout(()=>{if(I)return;Pt(w);const r=new Map(w.flyers.map(s=>[s.id,{r:s.pos.r,c:s.pos.c}])),a=performance.now();for(const s of i){if(!s.alive)continue;const v=r.get(s.id);if(v)(v.r!==s.pos.r||v.c!==s.pos.c)&&G.push({from:{...s.pos},to:{...v},kind:s.kind,t0:a,ttl:900});else{const g=Ct(s.pos,s.dir);G.push({from:{...s.pos},to:g,kind:s.kind,t0:a,ttl:900})}}for(const s of w.pieces)l.has(s.id)&&!s.alive&&Me(s.pos);const f=de(w);f&&(I={winner:f})},Kt),D=!1},Tt)}const Kt=700;L.addEventListener("click",e=>{const t=L.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,o=t.width,l=t.height,{factoryB:r,factoryW:a,panel:f}=Xe(o,l);if(I)return;if(re(n,i,a)||re(n,i,r)){w.sideToMove==="W"&&(q=!q,N=null,C=[]);return}if(q){if(re(n,i,f)){if(w.sideToMove!=="W")return;const u=w.manufacturing.W,m=Ze(f);for(const M of m)if(re(n,i,M.rect)){u>=M.cost&&(O=M.type);return}return}const y=He(n,i);if(!y){q=!1;return}if(w.sideToMove!=="W"){q=!1;return}const b=Je();if(y.r!==b){q=!1;return}new Set(w.pieces.filter(u=>u.alive).map(u=>u.id));const h=O,R=j[h];if(ae(w,y,h,R),w.sideToMove!=="W"){N=null,C=[],q=!1;const u=de(w);if(u){I={winner:u};return}Oe();return}q=!1;return}new Set(w.pieces.filter(y=>y.alive).map(y=>y.id));const s=He(n,i);if(!s)return;if(!N){const y=x(w,s);if(!y||y.side!==w.sideToMove)return;N=s,y.type==="R"?C=W(w,s,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1}]):y.type==="B"?C=W(w,s,[{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):y.type==="P"?C=X(w,s,y.side):y.type==="Q"?C=W(w,s,[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1},{dr:-1,dc:-1},{dr:-1,dc:1},{dr:1,dc:-1},{dr:1,dc:1}]):y.type==="N"?C=Z(w,s):y.type==="K"?C=ee(w,s):C=[];return}const v=new Set(w.pieces.filter(y=>y.alive).map(y=>y.id));U(w,Y(N,s));for(const y of w.pieces)v.has(y.id)&&!y.alive&&Me(y.pos);N=null,C=[];let g=de(w);if(g){I={winner:g};return}Oe()});function Ot(){const e=Mt(),t=2,n=e.sampleRate,i=Math.floor(n*t),o=e.createBuffer(1,i,n),l=o.getChannelData(0);for(let s=0;s<i;s++)l[s]=Math.random()*2-1;const r=e.createBufferSource();r.buffer=o;const a=e.createBiquadFilter();a.type="lowpass",a.frequency.setValueAtTime(22e3,e.currentTime),a.frequency.exponentialRampToValueAtTime(12e3,e.currentTime+t);const f=e.createGain();f.gain.setValueAtTime(1e-4,e.currentTime),f.gain.exponentialRampToValueAtTime(.8,e.currentTime+.02),f.gain.exponentialRampToValueAtTime(1e-4,e.currentTime+t),r.connect(a),a.connect(f),f.connect(e.destination),r.start(),r.stop(e.currentTime+t)}function Me(e,t=3e3){le.push({sq:e,t0:performance.now(),ttl:t}),Ot()}function _t(e){const t=L.getBoundingClientRect(),n=t.width,i=t.height,{x0:o,y0:l,tileSize:r,boardW:a,boardH:f}=Be(n,i);c.clearRect(0,0,n,i),c.fillStyle="#05070c",c.fillRect(0,0,n,i);for(let d=0;d<A;d++)for(let u=0;u<E;u++){const m=(d+u)%2===1;c.fillStyle=m?"#2a303d":"#c9ced9",c.fillRect(o+u*r,l+d*r,r,r)}if(C.length>0){c.fillStyle="rgba(72,187,120,0.25)";for(const d of C)c.fillRect(o+d.c*r,l+d.r*r,r,r)}const s=performance.now();for(let d=G.length-1;d>=0;d--){const u=G[d],m=s-u.t0;if(m>=u.ttl){G.splice(d,1);continue}const M=1-m/u.ttl;c.save(),c.globalAlpha=.45*M,c.fillStyle=u.kind==="comet"?"rgba(255, 110, 40, 1)":"rgba(180, 190, 205, 1)",c.fillRect(o+u.from.c*r,l+u.from.r*r,r,r),c.globalAlpha=.6*M,c.fillRect(o+u.to.c*r,l+u.to.r*r,r,r),c.restore()}if(q&&e.sideToMove==="W"&&Wt(e)){const d=Je();c.fillStyle="rgba(66, 153, 225, 0.20)";for(let u=0;u<E;u++){const m={r:d,c:u};if(x(e,m)||T(e,m))continue;const M=$(e,m);M&&M.alive||c.fillRect(o+u*r,l+d*r,r,r)}}c.lineWidth=Rt,c.strokeStyle="#9aa3b2",c.strokeRect(o,l,a,f),c.fillStyle="rgba(255,255,255,0.6)",c.font=`${Math.floor(r*.28)}px system-ui, sans-serif`,c.textAlign="right",c.textBaseline="middle";for(let d=0;d<A;d++){const u=A-d,m=l+(d+.5)*r;c.fillText(String(u),o-8,m)}c.textAlign="center",c.textBaseline="top";for(let d=0;d<E;d++){const u=xt[d]??"?",m=o+(d+.5)*r;c.fillText(u,m,l+f+6)}for(const d of e.statics){const u=o+(d.pos.c+.5)*r,m=l+(d.pos.r+.5)*r,M=r*.38;d.kind==="planet"?(c.fillStyle="#2b6cb0",c.beginPath(),c.arc(u,m,M,0,Math.PI*2),c.fill()):(c.fillStyle="#f6e05e",c.beginPath(),c.arc(u,m,M,0,Math.PI*2),c.fill(),c.strokeStyle="rgba(246,224,94,0.5)",c.lineWidth=3,c.beginPath(),c.arc(u,m,M*1.35,0,Math.PI*2),c.stroke())}for(const d of e.flyers){const u=o+(d.pos.c+.5)*r,m=l+(d.pos.r+.5)*r;let M=0,B=0;switch(d.dir){case"E":M=1,B=0;break;case"W":M=-1,B=0;break;case"N":M=0,B=-1;break;case"S":M=0,B=1;break}const p=d.kind==="asteroid",P=r*(p?.28:.5),k=r*(p?.18:.25),K=u-M*P,_=m-B*P;c.save(),c.globalAlpha=p?.75:.85,c.fillStyle=p?"rgba(180, 190, 205, 0.45)":"rgba(248, 15, 3, 0.55)",c.beginPath();const z=-B,H=M,V=u+z*(k*.7),ye=m+H*(k*.7),te=u-z*(k*.7),ne=m-H*(k*.7),oe=K+z*(k*.1),rt=_+H*(k*.1),it=K-z*(k*.1),ct=_-H*(k*.1);c.moveTo(V,ye),c.lineTo(te,ne),c.lineTo(it,ct),c.lineTo(oe,rt),c.closePath(),c.fill(),c.globalAlpha=1,c.fillStyle=p?"#8a96a6":"#c77e47ff",c.beginPath(),c.arc(u,m,r*(p?.15:.17),0,Math.PI*2),c.fill(),c.globalAlpha=p?.65:.9,c.fillStyle=p?"rgba(230, 235, 245, 0.65)":"rgba(203, 165, 116, 0.85)",c.beginPath(),c.arc(u+M*r*.07,m+B*r*.07,r*.05,0,Math.PI*2),c.fill(),c.restore()}for(const d of e.pieces){if(!d.alive)continue;const u=o+(d.pos.c+.5)*r,m=l+(d.pos.r+.5)*r,M=d.type==="K"?"King":d.type==="Q"?"Queen":d.type==="R"?"Rook":d.type==="B"?"Bishop":d.type==="N"?"Knight":"Pawn",B=`${d.side}_${M}`,p=Ue[B];if(!p||!p.complete)continue;const P=1,k=6,K=r*1.1,_=Math.max(P,Math.min(k,Math.round(K/Ce))),z=St*_,H=Ce*_,V=Math.floor(H*.15);c.drawImage(p,Math.round(u-z/2),Math.round(m-H/2-V),z,H),d.heated&&(c.strokeStyle="rgba(246,224,94,0.9)",c.lineWidth=3,c.beginPath(),c.arc(u,m,r*.42,0,Math.PI*2),c.stroke())}const v=performance.now();for(let d=le.length-1;d>=0;d--){const u=le[d],m=v-u.t0;if(m>=u.ttl){le.splice(d,1);continue}const M=m/u.ttl,B=o+(u.sq.c+.5)*r,p=l+(u.sq.r+.5)*r,P=r*(.1+.55*M),k=r*(.06+.3*M);c.save(),c.globalAlpha=.85*(1-M),c.strokeStyle=`rgba(255, ${Math.floor(160*(1-M))}, 0, 1)`,c.lineWidth=Math.max(1,r*.07*(1-M)),c.beginPath(),c.arc(B,p,P,0,Math.PI*2),c.stroke(),c.globalAlpha=.65*(1-M),c.fillStyle="rgba(255, 60, 0, 1)",c.beginPath(),c.arc(B,p,k,0,Math.PI*2),c.fill(),c.restore()}N&&(c.strokeStyle="#48bb78",c.lineWidth=4,c.strokeRect(o+N.c*r+2,l+N.r*r+2,r-4,r-4));function g(d,u,m){c.strokeStyle=u,c.lineWidth=m,c.strokeRect(o+d.c*r+2,l+d.r*r+2,r-4,r-4)}J&&g(J,"rgba(229,62,62,0.85)",4),F&&g(F,"rgba(229,62,62,1)",4);const{factoryB:y,factoryW:b,panel:h}=Xe(n,i);function R(d,u,m){c.save(),c.globalAlpha=m?1:.55,c.fillStyle="rgba(255,255,255,0.10)",c.fillRect(d.x,d.y,d.w,d.h),c.strokeStyle="rgba(255,255,255,0.25)",c.lineWidth=2,c.strokeRect(d.x,d.y,d.w,d.h),c.globalAlpha=m?1:.45,c.fillStyle="rgba(255,255,255,0.92)",c.font="22px system-ui, sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText("üè≠",d.x+d.w/2,d.y+d.h*.4),c.font="16px system-ui, sans-serif",c.fillText(String(u),d.x+d.w/2,d.y+d.h*.78),c.restore()}if(R(y,e.manufacturing.B,e.sideToMove==="B"),R(b,e.manufacturing.W,e.sideToMove==="W"),q){c.save(),c.fillStyle="rgba(0,0,0,0.55)",c.fillRect(0,0,n,i),c.fillStyle="rgba(20,24,32,0.92)",c.fillRect(h.x,h.y,h.w,h.h),c.strokeStyle="rgba(255,255,255,0.25)",c.lineWidth=2,c.strokeRect(h.x,h.y,h.w,h.h),c.fillStyle="rgba(255,255,255,0.95)",c.textAlign="left",c.textBaseline="top",c.font="18px system-ui, sans-serif",c.fillText("Deploy Ship",h.x+16,h.y+14),c.font="14px system-ui, sans-serif",c.fillStyle="rgba(255,255,255,0.85)";const d=e.sideToMove,u=e.manufacturing[d];c.fillText(`Points: ${u} üè≠`,h.x+16,h.y+48),c.fillText(`Selected: ${O} (${Ee(O)})`,h.x+16,h.y+70);const m=Ze(h);for(const p of m){const P=u>=p.cost,k=p.type===O;c.save(),c.fillStyle=k?"rgba(72,187,120,0.22)":"rgba(255,255,255,0.06)",c.globalAlpha=P?1:.35,c.fillRect(p.rect.x,p.rect.y,p.rect.w,p.rect.h),c.strokeStyle="rgba(255,255,255,0.18)",c.lineWidth=1,c.strokeRect(p.rect.x,p.rect.y,p.rect.w,p.rect.h),c.fillStyle="rgba(255,255,255,0.92)",c.textAlign="left",c.textBaseline="middle",c.font="14px system-ui, sans-serif",c.fillText(`${p.type}  ${Ee(p.type)}   ‚Äî   ${p.cost} üè≠`,p.rect.x+10,p.rect.y+p.rect.h/2),c.restore()}const M=j[O],B=Math.max(0,M-u);d!=="W"?(c.fillStyle="rgba(255,120,120,0.95)",c.fillText("Deploy UI is White-only (for now).",h.x+16,h.y+92+150+10)):u<M?(c.fillStyle="rgba(255,120,120,0.95)",c.fillText(`Not enough points for ${O}: need ${B} more.`,h.x+16,h.y+92+150+10)):(c.fillStyle="rgba(200,255,200,0.95)",c.fillText("Click a square on rank 1 to deploy.",h.x+16,h.y+92+150+10)),c.fillStyle="rgba(255,255,255,0.6)",c.fillText("Click outside this panel to close.",h.x+16,h.y+h.h-34),c.restore()}I&&(c.save(),c.fillStyle="rgba(0,0,0,0.65)",c.fillRect(0,0,n,i),c.fillStyle="rgba(255,255,255,0.95)",c.textAlign="center",c.textBaseline="middle",c.font="48px system-ui, sans-serif",c.fillText(`${I.winner==="W"?"White":"Black"} wins`,n/2,i/2-20),c.font="18px system-ui, sans-serif",c.fillText("Press R to restart",n/2,i/2+30),c.restore())}function ot(){_t(w),requestAnimationFrame(ot)}ot();
